%%%%%%%%%%%%%%%%%%%% ALGORITMO REGRESSÃO LINEAR %%%%%%%%%%%%%%%%%%%%%%%%%%%

clear;
clc;

%%%%%%%%%%%%%%%%%%%% ENTRADA DE DADOS %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%Exemplo 1

%x = imc
%y =
 x = [20.1, 30.4,22,34,25,24,29,37.4,26,30,28.4,35,37,27,35.2,33,31,21.4,40,39,23.3,33.7,28,36,38.7,25,20.6,26,26.5,27];
 y = [100.5,125,103,118,110,113.5,114,132,121,120,115,122,130.4,114,125.3,122,121,103,138,134,107,127,122,132,138,114,109,116,108,117];
 n = 30;

%Exemplo 2

% x => Nível de Colesterol (mmol/L)
% y => Nivel de Triglicerídeos (mmol/L)
 x = [5.12,6.18,6.77,6.65,6.36,5.90,5.48,6.02,10.34,8.51];
 y = [2.30,2.54,2.95,3.77,4.18,5.31,5.53,8.83,9.48,14.20];
 n = 10;
%%%%%%%%%%%%%%%%%%%% INICIALIZAÇÃO DAS VARIÁVEIS %%%%%%%%%%%%%%%%%%%%%%%%%%

soma_x = 0;
soma_y = 0;
mult_xy = 0;
soma_x2 = 0;
soma_y2 = 0;
SQReg = 0;
SQTotal = 0;
contador = 0;
b = 0;
soma_erros = 0;
SQR = 0;
ordem_de_observacao = [1:n];
k = 1; %Grau de Liberdade


tabelasw=[0	0.7071	0.7071	0.6872	0.6646	0.6431	0.6233	0.6052	0.5888	0.5739	0.5601	0.5475	0.5359	0.5251	0.515	0.5056	0.4968	0.4886	0.4808	0.4734	0.4643	0.459	0.4542	0.4493	0.445	0.4407	0.4366	0.4328	0.4291	  0.4254
              0	     0	        0	    0.1677	0.2413	0.2806	0.3031	0.3164	0.3244	0.3291	0.3315	0.3325	0.3325	0.3318	0.3306	0.329	0.3273	0.3253	0.3232	0.3211	0.3185	0.3156	0.3126	0.3098	0.3069	0.3043	0.3018	0.2992	0.2968	0.2944
              0    	 0	        0	       0	       0	  0.0875   0.1401	0.1743	0.1976	0.2141	0.226	0.2347	0.2412	0.2495	0.2495	0.2521	0.254	0.2553	0.2561	0.2565	0.2578	0.2571	0.2563	0.2554	0.2543	0.2533	0.2522	0.251	0.2499	 0.2487
              0	     0	        0	       0	       0	      0	          0        0.0561  0.0947  0.1224  0.1429 0.1586  0.1707  0.1802  0.1878  0.1988  0.1988 0.2027	 0.2059	 0.2085	 0.2119	 0.2131	 0.2139	 0.2145	 0.2148	 0.2151	 0.2152	 0.2151	0.215	  0.2148
              0	     0	        0	       0	       0	      0	          0	          0         	0	  0.0399  0.0695 0.0922	 0.1099	 0.124	 0.1353	  0.1447  0.1524 0.1587	 0.1641	 0.1686	 0.1736	 0.1764	 0.1787	 0.1807	 0.1822	0.1836	0.1848	0.1857	0.1864	 0.187
              0	     0	        0	       0	       0	      0	          0	          0	            0	     0	         0	    0.0303	0.0539	0.0727	0.088	 0.1005	 0.1109	0.1197	0.1271	0.1334	0.1399	0.1443	0.148	0.1512	0.1539	0.1563	0.1584	0.1601	0.1616	0.163
              0	     0	        0	       0	       0	      0           0	          0	            0	     0	         0	        0	       0	   0.024	0.0433	0.0593	0.0725 0.0837  0.0932  0.1013  0.1092  0.115   0.1201  0.1245  0.1283  0.1316   0.1346  0.1372 0.1395   0.1415
              0	     0	        0	       0	       0	      0   	      0	          0	            0	     0	         0	        0	       0	     0	        0	      0.0196  0.0359 0.0496	 0.0612	 0.0711	 0.0804	 0.0878	 0.0941	0.0997	0.1046  0.1089	 0.1128	 0.1162	0.1192	 0.1219
              0	     0	        0	       0	       0	      0	          0	          0	            0	     0	         0	        0	       0	     0	        0	          0	         0	    0.0163	0.0303	0.0422	0.053	0.0618	0.0696	0.0764	0.0823	0.0876	0.0923	0.0965	0.1002	0.1036
              0	     0	        0	       0	       0	      0	          0	          0	            0	     0	         0	        0	       0 	     0	        0	          0	         0	       0	      0	       0.014    0.0263 0.0368  0.0459  0.0539  0.061	0.0672	0.0728	0.0778	0.0822	0.0862
              0	     0	        0	       0	       0	      0	          0	          0	            0	     0	         0	        0	       0	     0	        0	          0	         0	       0	      0           0	          0	     0.0122	 0.0228	 0.0321	 0.0403	 0.0476	  0.054	  0.0598  0.065	   0.0697
              0	     0	        0	       0	       0	      0	          0	          0	            0	     0	         0	        0	       0	     0	        0	          0	         0	       0	      0	          0	          0	         0	       0	   0.0107	0.02	 0.0284	  0.0358 0.0424	 0.0483	  0.0537
              0	     0	        0	       0	       0	      0	          0	          0	            0	     0	         0	        0	       0	     0	        0	          0	         0	       0	      0	          0	          0	         0	       0	       0	      0	      0.0094   0.0178  0.0253 0.032	    0.0381
              0	     0	        0	       0	       0	      0	          0	          0	            0	     0	         0	        0	       0	     0	        0	          0  	     0	       0	      0	          0	          0	         0	       0	       0	      0	          0	          0	     0.0084	 0.0159	  0.0227
              0	     0	        0	       0	       0	      0	          0	          0	            0	     0	         0	        0	       0	     0	        0	          0	         0	       0	      0	          0	          0	         0	       0	       0	      0	          0	          0	        0	        0	     0.0076];
t =[0 0 0
    0 0 0
    0.753 0.767	0.789
    0.687	0.748	0.792
    0.686	0.762	0.806
    0.713	0.788	0.826
    0.73	0.803	0.838
    0.749	0.818	0.851
    0.764	0.829	0.859
    0.781	0.842	0.869
    0.792	0.85	0.876
    0.805	0.859	0.883
    0.814	0.866	0.889
    0.825	0.874	0.895
    0.835	0.881	0.901
    0.844	0.887	0.906
    0.851	0.892	0.91
    0.858	0.897	0.914
    0.863	0.901	0.917
    0.868	0.905	0.92
    0.873	0.908	0.923
    0.878	0.911	0.926
    0.881	0.914	0.928
    0.884	0.916	0.93
    0.888	0.918	0.931
    0.891	0.92	0.933
    0.894	0.923	0.935
    0.896	0.924	0.936
    0.898	0.926	0.937
    0.9	0.927	0.939
    0.902	0.929	0.94
    0.904	0.93	0.941
    0.906	0.931	0.942
    0.908	0.933	0.943
    0.91	0.934	0.944
    0.912	0.935	0.945
    0.914	0.936	0.946
    0.916	0.938	0.947
    0.917	0.939	0.948
    0.919	0.94	0.949
    0.92	0.941	0.95
    0.922	0.942	0.951
    0.923	0.943	0.951
    0.924	0.944	0.952
    0.926	0.945	0.953
    0.927	0.945	0.953
    0.928	0.946	0.954
    0.929	0.947	0.954
    0.929	0.947	0.955
    0.93	0.947	0.955];

tabela_vcritico = [18.51 19.00 19.16 19.25 19.30 19.33 19.35 19.37 19.38 19.40 19.41 19.42 19.43 19.43 19.44 19.45 19.46 19.47 19.48 19.49;
                10.13 9.55 9.28 9.12 9.01 8.94 8.89 8.85 8.81 8.79 8.74 8.71 8.70 8.69 8.67 8.66 8.62 8.59 8.57 8.55
                7.71 6.94 6.59 6.39 6.26 6.16 6.09 6.04 6.00 5.96 5.91 5.87 5.86 5.84 5.82 5.80 5.75 5.72 5.69 5.66
                6.61 5.79 5.41 5.19 5.05 4.95 4.88 4.82 4.77 4.74 4.68 4.64 4.62 4.60 4.58 4.56 4.50 4.46 4.43 4.40
                5.99 5.14 4.76 4.53 4.39 4.28 4.21 4.15 4.10 4.06 4.00 3.96 3.94 3.92 3.90 3.87 3.81 3.77 3.74 3.70
                5.59 4.74 4.35 4.12 3.97 3.87 3.79 3.73 3.68 3.64 3.57 3.53 3.51 3.49 3.47 3.44 3.38 3.34 3.30 3.27
                5.32 4.46 4.07 3.84 3.69 3.58 3.50 3.44 3.39 3.35 3.28 3.24 3.22 3.20 3.17 3.15 3.08 3.04 3.01 2.97
                5.12 4.26 3.86 3.63 3.48 3.37 3.29 3.23 3.18 3.14 3.07 3.03 3.01 2.99 2.96 2.94 2.86 2.83 2.79 2.75
                4.96 4.10 3.71 3.48 3.33 3.22 3.14 3.07 3.02 2.98 2.91 2.86 2.85 2.83 2.80 2.77 2.70 2.66 2.62 2.58
                4.84 3.98 3.59 3.36 3.20 3.09 3.01 2.95 2.90 2.85 2.79 2.74 2.72 2.70 2.67 2.65 2.57 2.53 2.49 2.45
                4.75 3.89 3.49 3.26 3.11 3.00 2.91 2.85 2.80 2.75 2.69 2.64 2.62 2.60 2.57 2.54 2.47 2.43 2.38 2.34
                4.67 3.81 3.41 3.18 3.03 2.92 2.83 2.77 2.71 2.67 2.60 2.55 2.53 2.51 2.48 2.46 2.38 2.34 2.30 2.25
                4.60 3.74 3.34 3.11 2.96 2.85 2.76 2.70 2.65 2.60 2.53 2.48 2.46 2.44 2.41 2.39 2.31 2.27 2.22 2.18
                4.54 3.68 3.29 3.06 2.90 2.79 2.71 2.64 2.59 2.54 2.48 2.42 2.40 2.38 2.35 2.33 2.25 2.20 2.16 2.11
                4.49 3.63 3.24 3.01 2.85 2.74 2.66 2.59 2.54 2.49 2.42 2.37 2.35 2.33 2.30 2.28 2.19 2.15 2.11 2.06
                4.45 3.59 3.20 2.96 2.81 2.70 2.61 2.55 2.49 2.45 2.38 2.33 2.31 2.29 2.26 2.23 2.15 2.10 2.06 2.01
                4.41 3.55 3.16 2.93 2.77 2.66 2.58 2.51 2.46 2.41 2.34 2.29 2.27 2.25 2.22 2.19 2.11 2.06 2.02 1.97
                4.38 3.52 3.13 2.90 2.74 2.63 2.54 2.48 2.42 2.38 2.31 2.26 2.23 2.21 2.18 2.16 2.07 2.03 1.98 1.93
                4.35 3.49 3.10 2.87 2.71 2.60 2.51 2.45 2.39 2.35 2.28 2.22 2.20 2.18 2.15 2.12 2.04 1.99 1.95 1.90
                4.32 3.47 3.07 2.84 2.68 2.57 2.49 2.42 2.37 2.32 2.25 2.20 2.18 2.16 2.12 2.10 2.01 1.96 1.92 1.87
                4.30 3.44 3.05 2.82 2.66 2.55 2.46 2.40 2.34 2.30 2.23 2.17 2.15 2.13 2.10 2.07 1.98 1.94 1.89 1.84
                4.28 3.42 3.03 2.80 2.64 2.53 2.44 2.37 2.32 2.27 2.20 2.15 2.13 2.11 2.08 2.05 1.96 1.91 1.86 1.81
                4.26 3.40 3.01 2.78 2.62 2.51 2.42 2.36 2.30 2.25 2.18 2.13 2.11 2.09 2.05 2.03 1.94 1.89 1.84 1.79
                4.24 3.39 2.99 2.76 2.60 2.49 2.40 2.34 2.28 2.24 2.16 2.11 2.09 2.07 2.04 2.01 1.92 1.87 1.82 1.77
                4.23 3.37 2.98 2.74 2.59 2.47 2.39 2.32 2.27 2.22 2.15 2.09 2.07 2.05 2.02 1.99 1.90 1.85 1.80 1.75
                4.21 3.35 2.96 2.73 2.57 2.46 2.37 2.31 2.25 2.20 2.13 2.08 2.06 2.04 2.00 1.97 1.88 1.84 1.79 1.73
                4.20 3.34 2.95 2.71 2.56 2.45 2.36 2.29 2.24 2.19 2.12 2.06 2.04 2.02 1.99 1.96 1.87 1.82 1.77 1.71
                4.18 3.33 2.93 2.70 2.55 2.43 2.35 2.28 2.22 2.18 2.10 2.05 2.03 2.01 1.97 1.94 1.85 1.81 1.75 1.70
                4.17 3.32 2.92 2.69 2.53 2.42 2.33 2.27 2.21 2.16 2.09 2.04 2.01 1.99 1.96 1.93 1.84 1.79 1.74 1.68];

for i = 1:n
    
    soma_x = soma_x + x(i);
    soma_y = soma_y + y(i);
    mult_xy = mult_xy + x(i)*y(i);
    soma_x2 = soma_x2 + (x(i))^2;
    soma_y2 = soma_y2 + (y(i))^2;   
    
end

x_media = soma_x/n;
y_media = soma_y/n;

%%%%%%%%%%%%%%% COEFICIENTE DE CORRELAÇÃO DE PERSON %%%%%%%%%%%%%%%%%%%%%%%

r = (n*mult_xy - soma_x*soma_y)/(sqrt(n*soma_x2-(soma_x)^2)*sqrt(n*soma_y2-(soma_y)^2));

% AJUSTE RETA MÉTODO MINIMOS QUADRADOS
matriz1 = [n soma_x;soma_x soma_x2];
matriz2 = [soma_y; mult_xy];
X =matriz1^-1* matriz2;

%%%%%%%%%%%%%%%%  Coeficiente de Determinação R2 %%%%%%%%%%%%%%%%%%%%%%%%%%

for j = 1:n
    y_reta(j) = X(2,1)*x(j) + X(1,1);
    SQReg = SQReg + ((X(2,1)*x(j) + X(1,1))-y_media)^2;
    SQTotal = SQTotal + (y(j)-y_media)^2;
end

R2 = SQReg/SQTotal*100;

%%%%%%%%%%%%%%%%%%%%%%%%%%% Resíduo %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

for l = 1:n

    e(l) = y(l) -(X(2,1)*x(l) + X(1,1));

end

%%%%%%%%%%%%%%%%%%%% Teste Shapiro Wilks %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

erros = sort(e);

% CALCULANDO B
tamanho_verro = length(erros);
if rem(tamanho_verro, 2) == 0
    for i = 1 : n/2
       b = b + (tabelasw(i, n-1+1)*(erros(n-i+1)-erros(i)));
    end
else
    for i = 1: (n+1)/2   
       b = b + (tabelasw(i, n-1+1)*(erros(n-i+1)-erros(i)));
    end
end

%CALCULANDO ERRO MÉDIO

for i = 1:n
    soma_erros = soma_erros + erros(i);
end
erro_medio = soma_erros/n;

for i = 1:n
    SQR = SQR + ((erros(i) -erro_medio)^2);
end

p = (b^2)/SQR;

% VERFICAÇÃO VALOR CRÍTICO
% 90% = 1
% 95% = 2
% 99% = 3

if p > t(n,2)
    h = 0;
    disp("OS DADOS SEGUEM UMA DISTRIBUIÇÃO NORMAL.")
else
    h = 1;
    disp("OS DADOS NÃO SEGUEM UMA DISTRIBUIÇÃO NORMAL.")
end

%%%%%%%%%%%%%%%%%%%%%% TABELA REGREÇÃO LINEAR %%%%%%%%%%%%%%%%%%%%%%%%%%%%%

QMReg = SQReg/k;
QMR = SQR/(n-k-1);
F = QMReg/QMR;
valor_p = tabela_vcritico(n-1,k);

if QMReg>QMR
ajuste = "BOM AJUSTE";
else
ajuste = "NÃO OCORREU UM BOM AJUSTE";
end


if F> valor_p
    rejeicao_h = "Regeita H0";
else
    rejeicao_h = "Não rejeita H0";
end
tabela_anova = ["ANOVA", "Soma dos Quadrados","G.L", "Quadrado Médio", "Razão F", "Valor-p";
                "Devido a Regressão",SQReg, k, QMReg, F ,valor_p;
                "Devido aos Resíduos",SQR, n-k-1, QMR, "-","-";
                "Total",SQTotal, n-1,"-",ajuste,rejeicao_h];

%%%%%%%%%%%%%%%%%%%%%% RESIDUOS PADRONIZADOS %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

for i =1:n
    z(i) = e(i)/sqrt(QMR);
end

%%%%%%%%%%%%%%%%%%% PLOTS  %%%%%%%%%%%%%%%%%%%%%%%%%%%%

disp("COEFICIENTE DE CORRELAÇÃO DE PEARSON:"+ r);
disp("COEFICIENTE DE DETERMINAÇÃO:"+ R2 + "%");
disp("TESTE DE SHAPIRO WILKS: "+ p)
    figure(1), clf
    
    subplot(2,3,1)
    plot(x,y_reta,'g-')
    hold on
    plot(x,y,'O')
    hold on
    xlabel('x')
    ylabel('y')
    legend('- RETA MÉTODO MINIMOS QUADRADOS','O - CONJUNTO DE DADOS')
    title("Gráfico de Dispersão")
    
    
    %PLOT ERRO
    subplot(2,3,2)
    plot(x,e,'O')
    xlabel('x')
    ylabel('Resíduo')
    title('Resíduo')
    
    subplot(2,3,3)
    plot(y_reta, e, 'O')
    xlabel('Valor Ajustado')
    ylabel('Resíduo')
    title("Gráfico de Dispersão")
    
    subplot(2,3,4)
    plot(ordem_de_observacao, e, 'O')
    xlabel('Ordem de Observação')
    ylabel('Resíduo')
    title("Independência do Erro")

    subplot(2,3,5)
    plot(y_reta,z,'o')
    xlabel('Valor Ajustado')
    ylabel('Resíduo Padronizado')
    title("Avaliação Outliners")
